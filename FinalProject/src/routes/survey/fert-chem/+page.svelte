<script>
  export let data;
  export let form;

  let q1 = '';
  let q2 = '';
  let q3 = null;
  let q3Url = '';
  let q4 = '';
  let q5 = '';
  let q6 = '';
  let errors = {};

  let formEl;
  let submittedData = null;
  let showConfirm = false;
  let isSubmitting = false;

  const fertilizerRecords = data.fertilizerRecords;

  // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ Q3
  function handleFileChange(e) {
    const file = e.target.files?.[0];
    if (!file) return;
    if (q3Url) URL.revokeObjectURL(q3Url);
    q3 = file;
    q3Url = URL.createObjectURL(file);
  }


  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á
  function handleSubmit(e) {
    if (!isSubmitting) {
      e.preventDefault();
      submittedData = { q1, q2, q3, q4, q5, q6 };
      showConfirm = true;
    }
  }

  function confirmSubmit() {
    showConfirm = false;
    isSubmitting = true;
    formEl.requestSubmit();
  }

  function closeModal() {
    showConfirm = false;
  }

</script>

<h1>üß™ ‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πã‡∏¢‡πÅ‡∏•‡∏∞‡∏¢‡∏≤</h1>

<form
  bind:this={formEl}
  method="POST"
  action="?/submit"
  enctype="multipart/form-data"
  on:submit={handleSubmit}
>
  <!-- Q1 -->
  <div class="card">
    <p>Q1: ‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡πà‡∏á‡∏Ç‡∏±‡∏ö‡∏ñ‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏∏‡πã‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
    {#each ["‡πÉ‡∏ä‡πâ", "‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏¢", "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö"] as v}
      <label>
        <input type="radio" name="q1" bind:group={q1} value={v} required />
        {v}
      </label>
    {/each}
  </div>

  <!-- Q2 -->
  <div class="card">
    <p>Q2: ‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏•‡∏∞‡∏´‡∏¢‡∏∏‡∏î‡πÉ‡∏ä‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
    {#each ["‡πÉ‡∏ä‡πà", "‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà"] as v}
      <label>
        <input type="radio" name="q2" bind:group={q2} value={v} required />
        {v}
      </label>
    {/each}
  </div>

  <!-- Q3 -->
  <div class="card">
    <p>Q3: ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏∏‡πã‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>
    <input type="file" name="q3" accept="image/*" on:change={handleFileChange} required />
    {#if q3Url}<img src={q3Url} alt="preview" width="200" />{/if}
  </div>

  <!-- Q4 -->
  <div class="card">
    <p>Q4: ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡∏±‡∏î‡∏™‡∏≤‡∏£‡∏ï‡∏Å‡∏Ñ‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</p>
    <input type="text" name="q4" bind:value={q4} />
  </div>

  <!-- Q5 -->
  <div class="card">
    <p>Q5: ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
    {#each ["‡πÉ‡∏ä‡πâ", "‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ"] as v}
      <label>
        <input type="radio" name="q5" bind:group={q5} value={v} required />
        {v}
      </label>
    {/each}
  </div>

  <!-- Q6 -->
  <div class="card">
    <p>Q6: ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏Ñ‡∏π‡πà‡∏Ñ‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
    {#each ["‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥", "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥"] as v}
      <label>
        <input type="radio" name="q6" bind:group={q6} value={v} required />
        {v}
      </label>
    {/each}
  </div>

  <div class="actions">
    <button type="submit">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
  </div>
</form>

<form method="POST" action="?/reset" style="margin-top:1rem;">
  <button type="submit" class="reset">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
</form>

<!-- ‚úÖ Modal ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô -->
{#if showConfirm && submittedData}
  <div class="modal-backdrop" on:click={closeModal}>
    <div class="modal" on:click|stopPropagation>
      <h3>üßæ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á</h3>
      <ul>
        <li><strong>Q1:</strong> {submittedData.q1}</li>
        <li><strong>Q2:</strong> {submittedData.q2}</li>
        <li><strong>Q3:</strong> {submittedData.q3?.name}</li>
        <li><strong>Q4:</strong> {submittedData.q4}</li>
        <li><strong>Q5:</strong> {submittedData.q5}</li>
        <li><strong>Q6:</strong> {submittedData.q6}</li>
      </ul>

      {#if q3Url}
        <p><strong>‡∏†‡∏≤‡∏û‡πÅ‡∏ô‡∏ö Q3:</strong></p>
        <img src={q3Url} alt="preview" width="200" />
      {/if}

      <div class="modal-actions">
        <button on:click={closeModal}>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        <button class="confirm" on:click={confirmSubmit}>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
      </div>
    </div>
  </div>
{/if}



<style>
  .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 14px; margin-bottom: 12px; }
  .card label { display: block; margin-top: 6px; }
  .actions { margin-top: 12px; display: flex; gap: 10px; }
  .error { color: #b91c1c; font-size: 0.9rem; margin-top: 4px; }
  .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
  .modal { background: #fff; padding: 20px; border-radius: 12px; max-width: 400px; width: 90%; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
  .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 16px; }
  .confirm { background: #16a34a; color: #fff; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; }
  .confirm:hover { opacity: 0.9; }
  .actions button { background: #16a34a; color: #fff; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: background 0.2s; }
  .actions button:hover { opacity: 0.9; }
  form .reset { background: #ef4444; color: #fff; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: background 0.2s; }
  form .reset:hover { background: #b91c1c; }
</style>
